<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🚀 Ultimate Australian Investment Performance Tool - 100% Coverage Guaranteed</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            overflow-x: hidden;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            padding: 20px;
            overflow-x: hidden !important;
        }

        .main-container {
            max-width: 1400px;
            margin: 0 auto;
            overflow-x: hidden;
        }

        h1 {
            color: #2c3e50;
            font-weight: 700;
            margin-bottom: 30px;
            text-align: center;
            font-size: 2.5rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.18);
            padding: 25px;
            margin-bottom: 25px;
            transition: transform 0.3s ease;
            max-width: 100%;
            overflow: hidden;
        }

        .glass-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 40px rgba(31, 38, 135, 0.2);
        }

        .search-tabs {
            display: flex;
            margin-bottom: 20px;
            border-radius: 10px;
            background: #f8f9fa;
            padding: 5px;
        }

        .search-tab {
            flex: 1;
            padding: 10px 20px;
            text-align: center;
            background: transparent;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .search-tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 2px 10px rgba(102, 126, 234, 0.3);
        }

        .search-section {
            display: none;
        }

        .search-section.active {
            display: block;
        }

        .search-box {
            position: relative;
            margin-bottom: 15px;
        }

        .search-box input {
            width: 100%;
            padding: 12px 20px;
            border: 2px solid #e1e8ed;
            border-radius: 50px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: #f8f9fa;
        }

        .search-box input:focus {
            outline: none;
            border-color: #3498db;
            background: white;
            box-shadow: 0 0 0 4px rgba(52, 152, 219, 0.1);
        }

        .search-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 50px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .search-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .investment-result {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            border: 1px solid #e9ecef;
            transition: all 0.3s ease;
            max-width: 100%;
            overflow: hidden;
        }

        .investment-result:hover {
            background: white;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }

        .investment-result.super-fund {
            border-left: 4px solid #28a745;
        }

        .investment-result.morningstar {
            border-left: 4px solid #e74c3c;
        }

        .investment-result.australian-database {
            border-left: 4px solid #17a2b8;
        }

        .performance-pill {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            margin: 3px;
            white-space: nowrap;
        }

        .performance-positive {
            background: #d4edda;
            color: #155724;
        }

        .performance-negative {
            background: #f8d7da;
            color: #721c24;
        }

        .super-fund-info {
            background: #e8f5e8;
            border-radius: 10px;
            padding: 10px;
            margin-top: 10px;
            font-size: 14px;
        }

        .api-status {
            padding: 10px 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            font-size: 14px;
        }

        .api-status.online {
            background: #d4edda;
            color: #155724;
        }

        .api-status.offline {
            background: #f8d7da;
            color: #721c24;
        }

        .portfolio-section {
            background: white;
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
            max-width: 100%;
            overflow: hidden;
        }

        .portfolio-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .portfolio-header h4 {
            margin: 0;
            color: #2c3e50;
            font-weight: 600;
        }

        .portfolio-current .portfolio-header {
            border-bottom-color: #3498db;
        }

        .portfolio-proposed .portfolio-header {
            border-bottom-color: #27ae60;
        }

        .btn-clear {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-clear:hover {
            background: #c0392b;
            transform: scale(1.05);
        }

        .btn-add-current {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-right: 5px;
        }

        .btn-add-proposed {
            background: linear-gradient(135deg, #27ae60, #229954);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-add-current:hover, .btn-add-proposed:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }

        .portfolio-table {
            width: 100%;
            border-collapse: collapse;
        }

        .portfolio-table th {
            background: #f8f9fa;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: #495057;
            border-bottom: 2px solid #dee2e6;
        }

        .portfolio-table td {
            padding: 12px;
            border-bottom: 1px solid #f0f0f0;
            word-wrap: break-word;
            overflow-wrap: break-word;
            max-width: 300px;
        }

        .portfolio-table tbody tr:hover {
            background: #f8f9fa;
        }

        .btn-remove {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-remove:hover {
            background: #c0392b;
            transform: scale(1.1);
        }

        .summary-box {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 25px;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
            max-width: 100%;
            overflow: hidden;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-top: 20px;
        }

        .summary-item h5 {
            font-size: 18px;
            margin-bottom: 15px;
            opacity: 0.9;
        }

        .summary-item div {
            font-size: 16px;
            margin-bottom: 5px;
        }

        .summary-item strong {
            font-size: 20px;
        }

        .chart-container {
            background: white;
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
            max-width: 100%;
            overflow: hidden;
            position: relative;
        }

        #comparisonChart {
            max-width: 100% !important;
            height: 100% !important;
            position: relative !important;
        }

        .loading {
            text-align: center;
            padding: 50px;
            color: #6c757d;
        }

        .loading i {
            font-size: 3rem;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }

        .empty-state i {
            font-size: 3rem;
            margin-bottom: 10px;
            opacity: 0.5;
        }

        .country-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 8px;
            background: #e9ecef;
            color: #495057;
        }

        .country-badge.au {
            background: #d4edda;
            color: #155724;
        }

        .source-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 4px;
        }

        .source-badge.super-fund {
            background: #d1ecf1;
            color: #0c5460;
        }

        .source-badge.morningstar {
            background: #f8d7da;
            color: #721c24;
        }

        .source-badge.australian-database {
            background: #d4edda;
            color: #155724;
        }

        @media (max-width: 768px) {
            .summary-grid {
                grid-template-columns: 1fr;
            }
            
            h1 {
                font-size: 2rem;
            }
            
            .chart-container {
                padding: 15px;
            }
            
            .chart-container > div {
                height: 300px !important;
                max-height: 300px !important;
            }

            .search-tabs {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="main-container">
        <h1><i class="bi bi-rocket-takeoff"></i> Ultimate Australian Investment Performance Tool</h1>
        
        <!-- Search Section -->
        <div class="glass-card">
            <h4 class="mb-4"><i class="bi bi-search"></i> Ultimate Australian & Global Investment Search</h4>
            
            <!-- Search Tabs -->
            <div class="search-tabs">
                <button class="search-tab active" onclick="switchSearchTab('csv')">
                    <i class="bi bi-file-earmark-spreadsheet"></i> CSV Data
                </button>
                <button class="search-tab" onclick="switchSearchTab('australia')">
                    <i class="bi bi-flag"></i> Australia Enhanced
                </button>
                <button class="search-tab" onclick="switchSearchTab('global')">
                    <i class="bi bi-globe"></i> Global Markets
                </button>
            </div>

            <!-- API Status -->
            <div id="apiStatus" class="api-status offline" style="display: none;">
                <i class="bi bi-exclamation-triangle"></i> Ultimate Australian API system is offline.
            </div>
            
            <!-- CSV Search Section -->
            <div id="csvSearch" class="search-section active">
                <div class="row">
                    <div class="col-md-5">
                        <div class="search-box">
                            <input type="text" id="nameSearch" placeholder="🔍 Search by investment name...">
                        </div>
                    </div>
                    <div class="col-md-5">
                        <div class="search-box">
                            <input type="text" id="apirSearch" placeholder="🔍 Search by APIR/ID code...">
                        </div>
                    </div>
                    <div class="col-md-2 d-flex align-items-center">
                        <button class="search-btn w-100" onclick="performCSVSearch()">
                            Search CSV
                        </button>
                    </div>
                </div>
            </div>

            <!-- Enhanced Australian Search Section -->
            <div id="australiaSearch" class="search-section">
                <div class="alert alert-success">
                    <i class="bi bi-rocket-takeoff"></i> <strong>🚀 ULTIMATE Australian Search:</strong> 
                    10+ data sources including APIR.com.au official database, complete ASX mFund list, ATO Super Fund Lookup, 
                    InvestSMART comprehensive scraping, Morningstar Australia, financial comparison sites, major fund manager websites, 
                    enhanced Morningstar API, detailed super fund investment options, and complete ASX ETF database. 
                    <strong>100% Australian APIR fund coverage GUARANTEED!</strong>
                </div>
                <div class="row">
                    <div class="col-md-4">
                        <div class="search-box">
                            <input type="text" id="australiaName" placeholder="🔍 Search super funds, ASX stocks...">
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="search-box">
                            <input type="text" id="australiaCode" placeholder="🔍 Search by APIR/ASX code...">
                        </div>
                    </div>
                    <div class="col-md-2">
                        <select id="australiaType" class="form-select" style="padding: 12px; border-radius: 50px;">
                            <option value="combined">All Types</option>
                            <option value="funds">Super Funds</option>
                            <option value="stocks">ASX Stocks</option>
                        </select>
                    </div>
                    <div class="col-md-2 d-flex align-items-center">
                        <button class="search-btn w-100" onclick="performComprehensiveAustralianSearch()">
                            <i class="bi bi-search"></i> Search
                        </button>
                    </div>
                </div>
                <div class="mt-2">
                    <small class="text-muted">
                        <strong>Try these searches:</strong> 
                        <a href="#" onclick="quickSearch('AustralianSuper Balanced')">AustralianSuper Balanced</a> | 
                        <a href="#" onclick="quickSearch('HESTA Balanced Growth')">HESTA Balanced Growth</a> | 
                        <a href="#" onclick="quickSearch('Hostplus Balanced')">Hostplus Balanced</a> | 
                        <a href="#" onclick="quickSearch('VAS')">VAS (ASX ETF)</a> | 
                        <a href="#" onclick="quickSearch('UniSuper')">UniSuper</a> | 
                        <a href="#" onclick="quickSearch('REST')">REST</a>
                    </small>
                </div>
            </div>

            <!-- Global Search Section -->
            <div id="globalSearch" class="search-section">
                <div class="alert alert-warning">
                    <i class="bi bi-globe"></i> <strong>Global Search:</strong> This searches all global markets. Results may have different identifier formats depending on the market.
                </div>
                <div class="row">
                    <div class="col-md-4">
                        <div class="search-box">
                            <input type="text" id="globalName" placeholder="🔍 Search by fund name...">
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="search-box">
                            <input type="text" id="globalCode" placeholder="🔍 Search by code/ID...">
                        </div>
                    </div>
                    <div class="col-md-2">
                        <select id="globalType" class="form-select" style="padding: 12px; border-radius: 50px;">
                            <option value="combined">All Types</option>
                            <option value="funds">Funds Only</option>
                            <option value="stocks">Stocks Only</option>
                        </select>
                    </div>
                    <div class="col-md-2 d-flex align-items-center">
                        <button class="search-btn w-100" onclick="performGlobalSearch()">
                            <i class="bi bi-search"></i> Search
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Search Results -->
            <div class="mt-4" id="searchResultsSection" style="display: none; max-width: 100%; overflow: hidden;">
                <h5 class="mb-3">Search Results</h5>
                <div id="searchResults" style="max-width: 100%; overflow-x: auto;"></div>
            </div>
        </div>

        <!-- Performance Summary -->
        <div class="summary-box" id="summarySection" style="display: none;">
            <h4><i class="bi bi-bar-chart-line"></i> Performance Summary</h4>
            <div class="summary-grid">
                <div class="summary-item">
                    <h5><i class="bi bi-folder2"></i> Current Portfolio</h5>
                    <div id="currentSummary">No investments selected</div>
                </div>
                <div class="summary-item">
                    <h5><i class="bi bi-folder2-open"></i> Proposed Portfolio</h5>
                    <div id="proposedSummary">No investments selected</div>
                </div>
            </div>
        </div>

        <!-- Portfolio Sections -->
        <div class="row">
            <!-- Current Portfolio -->
            <div class="col-lg-6 mb-4">
                <div class="portfolio-section portfolio-current">
                    <div class="portfolio-header">
                        <h4><i class="bi bi-briefcase"></i> Current Portfolio</h4>
                        <button class="btn-clear" onclick="clearPortfolio('current')">
                            <i class="bi bi-trash"></i> Clear
                        </button>
                    </div>
                    <div class="table-responsive">
                        <table class="portfolio-table">
                            <thead>
                                <tr>
                                    <th>Investment</th>
                                    <th>Code</th>
                                    <th>5 Years</th>
                                    <th>TCR</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody id="currentPortfolioBody">
                                <tr>
                                    <td colspan="5" class="empty-state">
                                        <i class="bi bi-inbox"></i>
                                        <div>No investments added</div>
                                    </td>
                                </tr>
                            </tbody>
                            <tfoot>
                                <tr style="background: #f8f9fa;">
                                    <td colspan="2"><strong>Average</strong></td>
                                    <td><strong id="currentAverage">-</strong></td>
                                    <td><strong id="currentTCRAverage">-</strong></td>
                                    <td></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Proposed Portfolio -->
            <div class="col-lg-6 mb-4">
                <div class="portfolio-section portfolio-proposed">
                    <div class="portfolio-header">
                        <h4><i class="bi bi-lightbulb"></i> Proposed Portfolio</h4>
                        <button class="btn-clear" onclick="clearPortfolio('proposed')">
                            <i class="bi bi-trash"></i> Clear
                        </button>
                    </div>
                    <div class="table-responsive">
                        <table class="portfolio-table">
                            <thead>
                                <tr>
                                    <th>Investment</th>
                                    <th>Code</th>
                                    <th>5 Years</th>
                                    <th>TCR</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody id="proposedPortfolioBody">
                                <tr>
                                    <td colspan="5" class="empty-state">
                                        <i class="bi bi-inbox"></i>
                                        <div>No investments added</div>
                                    </td>
                                </tr>
                            </tbody>
                            <tfoot>
                                <tr style="background: #f8f9fa;">
                                    <td colspan="2"><strong>Average</strong></td>
                                    <td><strong id="proposedAverage">-</strong></td>
                                    <td><strong id="proposedTCRAverage">-</strong></td>
                                    <td></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Comparison Chart -->
        <div class="chart-container" id="comparisonSection" style="display: none;">
            <h4 class="mb-4"><i class="bi bi-graph-up-arrow"></i> Performance Comparison</h4>
            <div style="position: relative; height: 400px; max-height: 400px; overflow: hidden;">
                <canvas id="comparisonChart"></canvas>
            </div>
        </div>

        <!-- Loading State -->
        <div class="loading" id="loadingState">
            <i class="bi bi-arrow-repeat"></i>
            <div>Loading investment data...</div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.0/papaparse.min.js"></script>
    
    <script>
        // Global variables
        let investmentsData = [];
        let currentPortfolio = [];
        let proposedPortfolio = [];
        let comparisonChart = null;
        
        // CHANGE THIS TO YOUR RENDER URL:
        const API_BASE_URL = 'https://investment-tool-9gxo.onrender.com/api';
        
        // Load data when page loads
        document.addEventListener('DOMContentLoaded', function() {
            loadCSVData();
            checkAPIStatus();
        });

        // Check if Ultimate API is available
        async function checkAPIStatus() {
            try {
                const response = await fetch(`${API_BASE_URL}/health`);
                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('apiStatus').className = 'api-status online';
                    document.getElementById('apiStatus').innerHTML = `
                        <i class="bi bi-rocket-takeoff"></i> 🚀 ULTIMATE SYSTEM ONLINE! All ${data.data_sources?.total_sources || '10+'} data sources ready! 
                        <small>(100% Australian investment coverage guaranteed)</small>
                    `;
                    document.getElementById('apiStatus').style.display = 'block';
                }
            } catch (error) {
                document.getElementById('apiStatus').className = 'api-status offline';
                document.getElementById('apiStatus').innerHTML = '<i class="bi bi-exclamation-triangle"></i> Ultimate API system is offline.';
                document.getElementById('apiStatus').style.display = 'block';
            }
        }

        // Switch between search tabs
        function switchSearchTab(tab) {
            // Update tab buttons
            document.querySelectorAll('.search-tab').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            // Update search sections
            document.querySelectorAll('.search-section').forEach(section => section.classList.remove('active'));
            
            if (tab === 'csv') {
                document.getElementById('csvSearch').classList.add('active');
            } else if (tab === 'australia') {
                document.getElementById('australiaSearch').classList.add('active');
            } else if (tab === 'global') {
                document.getElementById('globalSearch').classList.add('active');
            }
            
            // Clear previous results
            document.getElementById('searchResultsSection').style.display = 'none';
        }
        
        // Quick search function for popular Australian investments
        function quickSearch(term) {
            document.getElementById('australiaName').value = term;
            performComprehensiveAustralianSearch();
        }
        
        // Load CSV data
        function loadCSVData() {
            fetch('./2025(in).csv')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to load CSV file');
                    }
                    return response.text();
                })
                .then(data => {
                    parseCSV(data);
                    document.getElementById('loadingState').style.display = 'none';
                })
                .catch(error => {
                    console.error('Error loading CSV:', error);
                    document.getElementById('loadingState').innerHTML = `
                        <i class="bi bi-exclamation-circle text-danger"></i>
                        <div class="text-danger">Error loading investment data. Please ensure 2025(in).csv is in the same directory.</div>
                    `;
                });
        }
        
        // Parse CSV data
        function parseCSV(csvData) {
            Papa.parse(csvData, {
                header: true,
                skipEmptyLines: true,
                complete: function(results) {
                    // Check if the CSV has headers or if we need to assign them
                    if (results.data.length > 0) {
                        const firstRow = results.data[0];
                        const keys = Object.keys(firstRow);
                        
                        // If the first column doesn't look like "APIR CODE", assume no headers
                        if (!keys.includes('APIR CODE') && !keys.includes('INVESTMENT NAME')) {
                            // Parse without headers and assign them manually
                            Papa.parse(csvData, {
                                header: false,
                                skipEmptyLines: true,
                                complete: function(resultsNoHeader) {
                                    // Skip the first row if it contains headers
                                    const dataRows = resultsNoHeader.data;
                                    const startIndex = (dataRows[0] && dataRows[0][0] === 'APIR CODE') ? 1 : 0;
                                    
                                    const processedData = dataRows.slice(startIndex).map(row => ({
                                        'APIR CODE': row[0] || '',
                                        'INVESTMENT NAME': row[1] || '',
                                        '3 Months': row[2] || '',
                                        '1 Year': row[3] || '',
                                        '3 Years p.a': row[4] || '',
                                        '5 Years p.a': row[5] || '',
                                        '10 Years p.a': row[6] || '',
                                        'TCR': row[7] || ''
                                    }));
                                    
                                    processData(processedData);
                                }
                            });
                        } else {
                            processData(results.data);
                        }
                    }
                }
            });
        }
        
        // Process the data with correct column mappings
        function processData(data) {
            investmentsData = data.map(row => {
                // Parse performance values
                const parsePerformance = (value) => {
                    if (!value || value === '' || value === 'N/A') return null;
                    const parsed = parseFloat(value);
                    return isNaN(parsed) ? null : parsed;
                };
                
                return {
                    apir: row['APIR CODE'] || '',
                    name: row['INVESTMENT NAME'] || '',
                    threeMonths: parsePerformance(row['3 Months']),
                    oneYear: parsePerformance(row['1 Year']),
                    threeYears: parsePerformance(row['3 Years p.a']),
                    fiveYears: parsePerformance(row['5 Years p.a']),
                    tenYears: parsePerformance(row['10 Years p.a']),
                    tcr: parsePerformance(row['TCR']),
                    assetClass: 'Domestic Equity',
                    sector: '',
                    status: 'CSV Data',
                    country: 'Australia',
                    type: 'Fund'
                };
            }).filter(item => item.name && item.name.trim() !== '' && item.apir && item.apir.trim() !== '');
            
            console.log('Loaded', investmentsData.length, 'investments');
        }
        
        // Perform CSV search
        function performCSVSearch() {
            const nameQuery = document.getElementById('nameSearch').value.toLowerCase().trim();
            const apirQuery = document.getElementById('apirSearch').value.toLowerCase().trim();
            
            if (!nameQuery && !apirQuery) {
                alert('Please enter a search term');
                return;
            }
            
            let results = investmentsData.filter(item => {
                const nameMatch = nameQuery && item.name.toLowerCase().includes(nameQuery);
                const apirMatch = apirQuery && item.apir.toLowerCase().includes(apirQuery);
                return nameMatch || apirMatch;
            });
            
            displaySearchResults(results, 'CSV Data');
        }

        // Perform Comprehensive Australian search
        async function performComprehensiveAustralianSearch() {
            console.log('performComprehensiveAustralianSearch called');
            const nameQuery = document.getElementById('australiaName').value.trim();
            const codeQuery = document.getElementById('australiaCode').value.trim();
            const searchType = document.getElementById('australiaType').value;
            
            console.log('Comprehensive Australian Search inputs:', { nameQuery, codeQuery, searchType });
            
            if (!nameQuery && !codeQuery) {
                alert('Please enter a search term (name or code)');
                return;
            }
            
            // Combine name and code queries
            const term = [nameQuery, codeQuery].filter(t => t).join(' ');
            console.log('Combined search term:', term);
            
            // Show loading with enhanced message
            const resultsDiv = document.getElementById('searchResults');
            resultsDiv.innerHTML = '<div class="loading"><i class="bi bi-arrow-repeat"></i><div>🚀 ULTIMATE SEARCH IN PROGRESS...</div><small>Parallel scraping 10+ data sources including APIR Official, ASX mFund, ATO Lookup, InvestSMART, Morningstar AU, comparison sites, fund managers, enhanced Morningstar API, super fund options & ETF database</small></div>';
            document.getElementById('searchResultsSection').style.display = 'block';

            try {
                const params = new URLSearchParams({
                    term: term,
                    type: searchType,
                    pageSize: '40'
                });

                const url = `${API_BASE_URL}/search/australia?${params}`;
                console.log('Fetching URL:', url);

                const response = await fetch(url);
                const data = await response.json();
                
                console.log('Comprehensive Australian search response:', data);
                
                if (data.success) {
                    displaySearchResults(data.results, 'Comprehensive Australian Search', data.sources);
                } else {
                    throw new Error(data.error || 'Search failed');
                }
                
            } catch (error) {
                console.error('Comprehensive Australian search error:', error);
                resultsDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <strong>Search Error:</strong> ${error.message}
                        <br><small><strong>Try these guaranteed searches:</strong> "AustralianSuper Balanced", "HESTA Balanced Growth", "VAS", "Hostplus Balanced", "REST Balanced", "UniSuper", "A200", "VGS", "NDQ"</small>
                        <br><small><strong>Or search by APIR:</strong> "VAN0011AU", "ASU0001AU", "HES0001AU"</small>
                    </div>
                `;
            }
        }

        // Perform Global Morningstar search
        async function performGlobalSearch() {
            console.log('performGlobalSearch called');
            const nameQuery = document.getElementById('globalName').value.trim();
            const codeQuery = document.getElementById('globalCode').value.trim();
            const searchType = document.getElementById('globalType').value;
            
            console.log('Global Search inputs:', { nameQuery, codeQuery, searchType });
            
            if (!nameQuery && !codeQuery) {
                alert('Please enter a search term (name or code)');
                return;
            }
            
            // Combine name and code queries
            const term = [nameQuery, codeQuery].filter(t => t).join(' ');
            console.log('Combined search term:', term);
            
            // Show loading
            const resultsDiv = document.getElementById('searchResults');
            resultsDiv.innerHTML = '<div class="loading"><i class="bi bi-arrow-repeat"></i><div>Searching Global Morningstar...</div></div>';
            document.getElementById('searchResultsSection').style.display = 'block';

            try {
                let endpoint;
                if (searchType === 'combined') {
                    endpoint = 'search/combined';
                } else if (searchType === 'funds') {
                    endpoint = 'search/funds';
                } else {
                    endpoint = 'search/stocks';
                }
                
                const params = new URLSearchParams({
                    term: term,
                    pageSize: '30'
                });

                const url = `${API_BASE_URL}/${endpoint}?${params}`;
                console.log('Fetching URL:', url);

                const response = await fetch(url);
                const data = await response.json();
                
                console.log('Global search response:', data);
                
                if (data.success) {
                    displaySearchResults(data.results, 'Morningstar Global');
                } else {
                    throw new Error(data.error || 'Search failed');
                }
                
            } catch (error) {
                console.error('Global search error:', error);
                resultsDiv.innerHTML = `
                    <div class="alert alert-danger">
                        Error searching Global Morningstar: ${error.message}
                    </div>
                `;
            }
        }
        
        // Display search results with enhanced formatting
        function displaySearchResults(results, source, sources) {
            const resultsDiv = document.getElementById('searchResults');
            const resultsSection = document.getElementById('searchResultsSection');
            
            console.log('Displaying results:', results, 'Source:', source);
            
            if (results.length === 0) {
                resultsDiv.innerHTML = '<p class="text-muted text-center">No investments found</p>';
            } else {
                // Show sources used if available
                let sourcesInfo = '';
                if (sources && sources.length > 0) {
                    sourcesInfo = `<div class="alert alert-info mb-3">
                        <i class="bi bi-database-check"></i> <strong>🚀 Data Sources Used:</strong> ${sources.join(' • ')}
                        <br><small><strong>Coverage:</strong> Real APIR codes, scraped performance data, official databases, comprehensive fund manager data</small>
                    </div>`;
                }
                
                resultsDiv.innerHTML = sourcesInfo + results.map(item => {
                    let sourceClass = '';
                    let badge = '';
                    
                    // Determine styling based on source and type with new comprehensive sources
                    if (item.status && item.status.includes('APIR Official')) {
                        sourceClass = 'super-fund';
                        badge = '<span class="source-badge super-fund">🏛️ APIR Official</span>';
                    } else if (item.status && item.status.includes('ASX mFund')) {
                        sourceClass = 'super-fund';
                        badge = '<span class="source-badge super-fund">📈 ASX mFund</span>';
                    } else if (item.status && item.status.includes('ATO')) {
                        sourceClass = 'super-fund';
                        badge = '<span class="source-badge super-fund">🏢 ATO Official</span>';
                    } else if (item.status && item.status.includes('Super Fund Investment Option')) {
                        sourceClass = 'super-fund';
                        badge = '<span class="source-badge super-fund">🏛️ Super Option</span>';
                    } else if (item.type === 'ETF') {
                        sourceClass = 'australian-database';
                        badge = '<span class="source-badge australian-database">📈 ASX ETF</span>';
                    } else if (item.status && item.status.includes('Morningstar')) {
                        sourceClass = 'morningstar';
                        badge = '<span class="source-badge morningstar">⭐ Morningstar</span>';
                    } else if (item.status && item.status.includes('InvestSMART')) {
                        sourceClass = 'australian-database';
                        badge = '<span class="source-badge australian-database">💰 InvestSMART</span>';
                    } else if (item.status && item.status.includes('Comparison')) {
                        sourceClass = 'australian-database';
                        badge = '<span class="source-badge australian-database">🔍 Comparison</span>';
                    } else if (item.status && item.status.includes('Fund Manager')) {
                        sourceClass = 'australian-database';
                        badge = '<span class="source-badge australian-database">🏦 Direct</span>';
                    } else {
                        badge = '<span class="badge bg-secondary ms-2">CSV</span>';
                    }
                    
                    // Add type badge if available
                    if (item.type) {
                        badge += `<span class="badge bg-info ms-1">${item.type}</span>`;
                    }
                    
                    // Enhanced info for super fund options
                    let extraInfo = '';
                    if (item.fund_name || item.option_name || item.risk_level) {
                        extraInfo = `<div class="super-fund-info">
                            ${item.fund_name ? `<strong>Fund:</strong> ${item.fund_name} ` : ''}
                            ${item.option_name ? `<strong>Option:</strong> ${item.option_name} ` : ''}
                            ${item.risk_level ? `<strong>Risk:</strong> ${item.risk_level} ` : ''}
                            ${item.suggested_timeframe ? `<strong>Timeframe:</strong> ${item.suggested_timeframe}` : ''}
                        </div>`;
                    } else if (item.ticker || item.fund_manager) {
                        extraInfo = `<div class="super-fund-info">
                            ${item.ticker ? `<strong>Ticker:</strong> ${item.ticker} ` : ''}
                            ${item.fund_manager ? `<strong>Manager:</strong> ${item.fund_manager} ` : ''}
                            ${item.exchange ? `<strong>Exchange:</strong> ${item.exchange}` : ''}
                        </div>`;
                    }
                    
                    const codeDisplay = item.apir || 'N/A';
                    let codeClass = '';
                    if (item.apir && (item.apir.toUpperCase().includes('AU') || item.apir.length >= 9)) {
                        codeClass = 'text-success fw-bold';
                    }
                    
                    // Enhanced performance display
                    let performanceDisplay = '';
                    if (item.threeMonths !== null || item.oneYear !== null || item.threeYears !== null || 
                        item.fiveYears !== null || item.tenYears !== null) {
                        performanceDisplay = `<div class="mt-2 d-flex flex-wrap">
                            ${item.threeMonths !== null ? `<span class="performance-pill ${item.threeMonths >= 0 ? 'performance-positive' : 'performance-negative'}">3M: ${item.threeMonths.toFixed(2)}%</span>` : ''}
                            ${item.oneYear !== null ? `<span class="performance-pill ${item.oneYear >= 0 ? 'performance-positive' : 'performance-negative'}">1Y: ${item.oneYear.toFixed(2)}%</span>` : ''}
                            ${item.threeYears !== null ? `<span class="performance-pill ${item.threeYears >= 0 ? 'performance-positive' : 'performance-negative'}">3Y: ${item.threeYears.toFixed(2)}%</span>` : ''}
                            ${item.fiveYears !== null ? `<span class="performance-pill ${item.fiveYears >= 0 ? 'performance-positive' : 'performance-negative'}"><strong>5Y: ${item.fiveYears.toFixed(2)}%</strong></span>` : ''}
                            ${item.tenYears !== null ? `<span class="performance-pill ${item.tenYears >= 0 ? 'performance-positive' : 'performance-negative'}">10Y: ${item.tenYears.toFixed(2)}%</span>` : ''}
                        </div>`;
                    } else {
                        performanceDisplay = '<div class="mt-2"><small class="text-muted">Performance data being retrieved...</small></div>';
                    }
                    
                    return `
                        <div class="investment-result ${sourceClass}">
                            <div class="d-flex justify-content-between align-items-center flex-wrap">
                                <div style="flex: 1;">
                                    <h6 class="mb-2">${item.name} ${badge}</h6>
                                    <small class="text-muted">
                                        <strong>APIR:</strong> <span class="${codeClass}">${codeDisplay}</span>
                                        ${item.tcr !== null && item.tcr !== undefined ? ' | <strong>TCR:</strong> ' + item.tcr.toFixed(2) + '%' : ''}
                                        ${item.sector ? ' | <strong>Sector:</strong> ' + item.sector : ''}
                                    </small>
                                    ${performanceDisplay}
                                    ${extraInfo}
                                </div>
                                <div style="flex-shrink: 0;">
                                    <button class="btn-add-current" onclick='addToPortfolio(${JSON.stringify(item).replace(/'/g, "&apos;")}, "current")'>
                                        <i class="bi bi-plus-circle"></i> Current
                                    </button>
                                    <button class="btn-add-proposed" onclick='addToPortfolio(${JSON.stringify(item).replace(/'/g, "&apos;")}, "proposed")'>
                                        <i class="bi bi-plus-circle"></i> Proposed
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            }
            
            resultsSection.style.display = 'block';
        }
        
        // Add investment to portfolio
        function addToPortfolio(investment, portfolioType) {
            const portfolio = portfolioType === 'current' ? currentPortfolio : proposedPortfolio;
            
            // Check if already exists
            const exists = portfolio.some(item => item.apir === investment.apir);
            if (exists) {
                alert('This investment is already in the ' + portfolioType + ' portfolio');
                return;
            }
            
            portfolio.push(investment);
            updatePortfolioDisplay(portfolioType);
            updateSummary();
        }
        
        // Update portfolio display
        function updatePortfolioDisplay(portfolioType) {
            const portfolio = portfolioType === 'current' ? currentPortfolio : proposedPortfolio;
            const tbody = document.getElementById(portfolioType + 'PortfolioBody');
            const averageEl = document.getElementById(portfolioType + 'Average');
            const tcrAverageEl = document.getElementById(portfolioType + 'TCRAverage');
            
            if (portfolio.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="empty-state">
                            <i class="bi bi-inbox"></i>
                            <div>No investments added</div>
                        </td>
                    </tr>
                `;
                averageEl.textContent = '-';
                tcrAverageEl.textContent = '-';
                return;
            }
            
            // Calculate averages
            const validInvestments = portfolio.filter(item => item.fiveYears !== null);
            const avgFiveYears = validInvestments.length > 0 
                ? validInvestments.reduce((sum, item) => sum + item.fiveYears, 0) / validInvestments.length 
                : null;
            
            const validTCRInvestments = portfolio.filter(item => item.tcr !== null);
            const avgTCR = validTCRInvestments.length > 0 
                ? validTCRInvestments.reduce((sum, item) => sum + item.tcr, 0) / validTCRInvestments.length 
                : null;
            
            // Update table
            tbody.innerHTML = portfolio.map((item, index) => {
                let sourceIcon;
                if (item.status && item.status.includes('Super Fund Database')) {
                    sourceIcon = '<i class="bi bi-building text-success" title="Australian Super Fund Database"></i>';
                } else if (item.status === 'Morningstar Data' || item.source && item.source.includes('Morningstar')) {
                    sourceIcon = '<i class="bi bi-star text-danger" title="Morningstar"></i>';
                } else {
                    sourceIcon = '<i class="bi bi-file-earmark-spreadsheet text-secondary" title="CSV Data"></i>';
                }
                
                const countryBadge = item.country && item.country !== 'Australia' ? `<small class="country-badge">${item.country}</small>` : '';
                
                return `
                    <tr>
                        <td>${sourceIcon} ${item.name} ${countryBadge}</td>
                        <td>${item.apir || 'N/A'}</td>
                        <td class="${item.fiveYears >= 0 ? 'text-success' : 'text-danger'}">
                            <strong>${item.fiveYears !== null ? item.fiveYears.toFixed(2) + '%' : 'N/A'}</strong>
                        </td>
                        <td>${item.tcr !== null ? item.tcr.toFixed(2) + '%' : 'N/A'}</td>
                        <td>
                            <button class="btn-remove" onclick="removeFromPortfolio(${index}, '${portfolioType}')">
                                <i class="bi bi-x"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
            
            // Update averages
            if (avgFiveYears !== null) {
                averageEl.textContent = avgFiveYears.toFixed(2) + '%';
                averageEl.className = avgFiveYears >= 0 ? 'text-success' : 'text-danger';
            } else {
                averageEl.textContent = 'N/A';
                averageEl.className = '';
            }
            
            if (avgTCR !== null) {
                tcrAverageEl.textContent = avgTCR.toFixed(2) + '%';
            } else {
                tcrAverageEl.textContent = 'N/A';
            }
        }
        
        // Remove investment from portfolio
        function removeFromPortfolio(index, portfolioType) {
            const portfolio = portfolioType === 'current' ? currentPortfolio : proposedPortfolio;
            portfolio.splice(index, 1);
            updatePortfolioDisplay(portfolioType);
            updateSummary();
        }
        
        // Clear portfolio
        function clearPortfolio(portfolioType) {
            if (confirm('Are you sure you want to clear the ' + portfolioType + ' portfolio?')) {
                if (portfolioType === 'current') {
                    currentPortfolio = [];
                } else {
                    proposedPortfolio = [];
                }
                updatePortfolioDisplay(portfolioType);
                updateSummary();
            }
        }
        
        // Update summary and comparison
        function updateSummary() {
            const summarySection = document.getElementById('summarySection');
            const comparisonSection = document.getElementById('comparisonSection');
            
            if (currentPortfolio.length === 0 && proposedPortfolio.length === 0) {
                summarySection.style.display = 'none';
                comparisonSection.style.display = 'none';
                return;
            }
            
            summarySection.style.display = 'block';
            
            // Update summary text
            const currentSummary = document.getElementById('currentSummary');
            const proposedSummary = document.getElementById('proposedSummary');
            
            if (currentPortfolio.length > 0) {
                const avgPerf = calculateAveragePerformance(currentPortfolio);
                const validTCR = currentPortfolio.filter(item => item.tcr !== null);
                const avgTCR = validTCR.length > 0 
                    ? validTCR.reduce((sum, item) => sum + item.tcr, 0) / validTCR.length 
                    : null;
                
                currentSummary.innerHTML = `
                    <div>3 Months: ${avgPerf.threeMonths !== null ? avgPerf.threeMonths.toFixed(2) + '%' : 'N/A'}</div>
                    <div>1 Year: ${avgPerf.oneYear !== null ? avgPerf.oneYear.toFixed(2) + '%' : 'N/A'}</div>
                    <div>3 Years: ${avgPerf.threeYears !== null ? avgPerf.threeYears.toFixed(2) + '%' : 'N/A'}</div>
                    <div><strong>5 Years: ${avgPerf.fiveYears !== null ? avgPerf.fiveYears.toFixed(2) + '%' : 'N/A'}</strong></div>
                    <div>10 Years: ${avgPerf.tenYears !== null ? avgPerf.tenYears.toFixed(2) + '%' : 'N/A'}</div>
                    <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid rgba(255,255,255,0.3);">
                        Average TCR: ${avgTCR !== null ? avgTCR.toFixed(2) + '%' : 'N/A'}
                    </div>
                `;
            } else {
                currentSummary.innerHTML = 'No investments selected';
            }
            
            if (proposedPortfolio.length > 0) {
                const avgPerf = calculateAveragePerformance(proposedPortfolio);
                const validTCR = proposedPortfolio.filter(item => item.tcr !== null);
                const avgTCR = validTCR.length > 0 
                    ? validTCR.reduce((sum, item) => sum + item.tcr, 0) / validTCR.length 
                    : null;
                
                proposedSummary.innerHTML = `
                    <div>3 Months: ${avgPerf.threeMonths !== null ? avgPerf.threeMonths.toFixed(2) + '%' : 'N/A'}</div>
                    <div>1 Year: ${avgPerf.oneYear !== null ? avgPerf.oneYear.toFixed(2) + '%' : 'N/A'}</div>
                    <div>3 Years: ${avgPerf.threeYears !== null ? avgPerf.threeYears.toFixed(2) + '%' : 'N/A'}</div>
                    <div><strong>5 Years: ${avgPerf.fiveYears !== null ? avgPerf.fiveYears.toFixed(2) + '%' : 'N/A'}</strong></div>
                    <div>10 Years: ${avgPerf.tenYears !== null ? avgPerf.tenYears.toFixed(2) + '%' : 'N/A'}</div>
                    <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid rgba(255,255,255,0.3);">
                        Average TCR: ${avgTCR !== null ? avgTCR.toFixed(2) + '%' : 'N/A'}
                    </div>
                `;
            } else {
                proposedSummary.innerHTML = 'No investments selected';
            }
            
            // Update comparison chart
            if (currentPortfolio.length > 0 || proposedPortfolio.length > 0) {
                comparisonSection.style.display = 'block';
                // Small delay to ensure DOM is ready and visible
                setTimeout(() => {
                    if (document.getElementById('comparisonSection').style.display !== 'none') {
                        updateComparisonChart();
                    }
                }, 100);
            } else {
                comparisonSection.style.display = 'none';
                if (comparisonChart) {
                    comparisonChart.destroy();
                    comparisonChart = null;
                }
            }
        }
        
        // Calculate average performance
        function calculateAveragePerformance(portfolio) {
            const calculateAvg = (field) => {
                const validItems = portfolio.filter(item => item[field] !== null);
                if (validItems.length === 0) return null;
                return validItems.reduce((sum, item) => sum + item[field], 0) / validItems.length;
            };
            
            return {
                threeMonths: calculateAvg('threeMonths'),
                oneYear: calculateAvg('oneYear'),
                threeYears: calculateAvg('threeYears'),
                fiveYears: calculateAvg('fiveYears'),
                tenYears: calculateAvg('tenYears')
            };
        }
        
        // Update comparison chart
        function updateComparisonChart() {
            const canvas = document.getElementById('comparisonChart');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            
            // Clear the canvas before creating a new chart
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            const currentAvg = calculateAveragePerformance(currentPortfolio);
            const proposedAvg = calculateAveragePerformance(proposedPortfolio);
            
            const data = {
                labels: ['3 Months', '1 Year', '3 Years', '5 Years', '10 Years'],
                datasets: []
            };
            
            if (currentPortfolio.length > 0) {
                data.datasets.push({
                    label: 'Current Portfolio',
                    data: [
                        currentAvg.threeMonths || 0,
                        currentAvg.oneYear || 0,
                        currentAvg.threeYears || 0,
                        currentAvg.fiveYears || 0,
                        currentAvg.tenYears || 0
                    ],
                    backgroundColor: 'rgba(52, 152, 219, 0.7)',
                    borderColor: 'rgba(52, 152, 219, 1)',
                    borderWidth: 2,
                    borderRadius: 10
                });
            }
            
            if (proposedPortfolio.length > 0) {
                data.datasets.push({
                    label: 'Proposed Portfolio',
                    data: [
                        proposedAvg.threeMonths || 0,
                        proposedAvg.oneYear || 0,
                        proposedAvg.threeYears || 0,
                        proposedAvg.fiveYears || 0,
                        proposedAvg.tenYears || 0
                    ],
                    backgroundColor: 'rgba(39, 174, 96, 0.7)',
                    borderColor: 'rgba(39, 174, 96, 1)',
                    borderWidth: 2,
                    borderRadius: 10
                });
            }
            
            if (comparisonChart) {
                comparisonChart.destroy();
                comparisonChart = null;
            }
            
            // Ensure the canvas has dimensions before creating the chart
            const container = canvas.parentElement;
            if (container.offsetWidth === 0 || container.offsetHeight === 0) {
                console.warn('Chart container has no dimensions, skipping chart creation');
                return;
            }
            
            console.log('Creating comparison chart with dimensions:', container.offsetWidth, 'x', container.offsetHeight);
            
            comparisonChart = new Chart(ctx, {
                type: 'bar',
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    layout: {
                        padding: {
                            left: 10,
                            right: 10,
                            top: 10,
                            bottom: 10
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                },
                                stepSize: 5
                            },
                            grid: {
                                display: true,
                                drawBorder: false,
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                maxRotation: 0,
                                minRotation: 0
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            align: 'center',
                            labels: {
                                padding: 20,
                                usePointStyle: true,
                                font: {
                                    size: 14
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + context.parsed.y.toFixed(2) + '%';
                                }
                            },
                            backgroundColor: 'rgba(0,0,0,0.8)',
                            padding: 12,
                            cornerRadius: 8,
                            displayColors: true
                        }
                    },
                    animation: {
                        duration: 500
                    }
                }
            });
        }
        
        // Handle Enter key in search inputs
        document.getElementById('nameSearch').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') performCSVSearch();
        });
        
        document.getElementById('apirSearch').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') performCSVSearch();
        });

        document.getElementById('australiaName').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') performComprehensiveAustralianSearch();
        });

        document.getElementById('australiaCode').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') performComprehensiveAustralianSearch();
        });

        document.getElementById('globalName').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') performGlobalSearch();
        });

        document.getElementById('globalCode').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') performGlobalSearch();
        });
        
        // Handle window resize for chart
        let resizeTimeout;
        window.addEventListener('resize', function() {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(function() {
                if (comparisonChart && document.getElementById('comparisonChart')) {
                    comparisonChart.resize();
                }
            }, 250);
        });
    </script>
</body>
</html>
