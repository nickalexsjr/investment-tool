<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Investment Performance Tool v2</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            overflow-x: hidden;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            padding: 20px;
            overflow-x: hidden !important;
        }

        .main-container {
            max-width: 1400px;
            margin: 0 auto;
            overflow-x: hidden;
        }

        h1 {
            color: #2c3e50;
            font-weight: 700;
            margin-bottom: 30px;
            text-align: center;
            font-size: 2.5rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.18);
            padding: 25px;
            margin-bottom: 25px;
            transition: transform 0.3s ease;
            max-width: 100%;
            overflow: hidden;
        }

        .glass-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 40px rgba(31, 38, 135, 0.2);
        }

        .search-tabs {
            display: flex;
            margin-bottom: 20px;
            border-radius: 10px;
            background: #f8f9fa;
            padding: 5px;
        }

        .search-tab {
            flex: 1;
            padding: 10px 20px;
            text-align: center;
            background: transparent;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .search-tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 2px 10px rgba(102, 126, 234, 0.3);
        }

        .search-section {
            display: none;
        }

        .search-section.active {
            display: block;
        }

        .search-box {
            position: relative;
            margin-bottom: 15px;
        }

        .search-box input, .form-control {
            width: 100%;
            padding: 12px 20px;
            border: 2px solid #e1e8ed;
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: #f8f9fa;
        }

        .search-box input:focus, .form-control:focus {
            outline: none;
            border-color: #3498db;
            background: white;
            box-shadow: 0 0 0 4px rgba(52, 152, 219, 0.1);
        }

        .search-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 50px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .search-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 50px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .investment-result, .investment-preview {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            border: 1px solid #e9ecef;
            transition: all 0.3s ease;
            max-width: 100%;
            overflow: hidden;
        }

        .investment-result:hover, .investment-preview:hover {
            background: white;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }

        .investment-result.morningstar {
            border-left: 4px solid #e74c3c;
        }

        .performance-pill {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            margin: 3px;
            white-space: nowrap;
        }

        .performance-positive {
            background: #d4edda;
            color: #155724;
        }

        .performance-negative {
            background: #f8d7da;
            color: #721c24;
        }

        .performance-neutral {
            background: #e2e3e5;
            color: #383d41;
        }

        .portfolio-section {
            background: white;
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
            max-width: 100%;
            overflow: hidden;
        }

        .portfolio-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .portfolio-header h4 {
            margin: 0;
            color: #2c3e50;
            font-weight: 600;
        }

        .portfolio-current .portfolio-header {
            border-bottom-color: #3498db;
        }

        .portfolio-proposed .portfolio-header {
            border-bottom-color: #27ae60;
        }

        .btn-clear {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-clear:hover {
            background: #c0392b;
            transform: scale(1.05);
        }

        .btn-add-current {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-right: 5px;
        }

        .btn-add-proposed {
            background: linear-gradient(135deg, #27ae60, #229954);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-add-current:hover, .btn-add-proposed:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }

        .portfolio-table {
            width: 100%;
            border-collapse: collapse;
        }

        .portfolio-table th {
            background: #f8f9fa;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: #495057;
            border-bottom: 2px solid #dee2e6;
        }

        .portfolio-table td {
            padding: 12px;
            border-bottom: 1px solid #f0f0f0;
            word-wrap: break-word;
            overflow-wrap: break-word;
            max-width: 300px;
        }

        .portfolio-table tbody tr:hover {
            background: #f8f9fa;
        }

        .btn-remove {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-remove:hover {
            background: #c0392b;
            transform: scale(1.1);
        }

        .summary-box {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 25px;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
            max-width: 100%;
            overflow: hidden;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-top: 20px;
        }

        .summary-item h5 {
            font-size: 18px;
            margin-bottom: 15px;
            opacity: 0.9;
        }

        .summary-item div {
            font-size: 16px;
            margin-bottom: 5px;
        }

        .summary-item strong {
            font-size: 20px;
        }

        .chart-container {
            background: white;
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
            max-width: 100%;
            overflow: hidden;
            position: relative;
        }

        #comparisonChart {
            max-width: 100% !important;
            height: 100% !important;
            position: relative !important;
        }

        .api-status {
            padding: 10px 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            font-size: 14px;
        }

        .api-status.online {
            background: #d4edda;
            color: #155724;
        }

        .api-status.offline {
            background: #f8d7da;
            color: #721c24;
        }

        .loading {
            text-align: center;
            padding: 50px;
            color: #6c757d;
        }

        .loading i {
            font-size: 3rem;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }

        .empty-state i {
            font-size: 3rem;
            margin-bottom: 10px;
            opacity: 0.5;
        }

        .country-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 8px;
            background: #e9ecef;
            color: #495057;
        }

        .country-badge.au {
            background: #d4edda;
            color: #155724;
        }

        .country-badge.us {
            background: #cce5ff;
            color: #004085;
        }

        .country-badge.uk {
            background: #f8d7da;
            color: #721c24;
        }

        .performance-input-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .performance-input-group label {
            font-size: 14px;
            font-weight: 600;
            color: #495057;
            margin-bottom: 5px;
            display: block;
        }

        .reset-form-btn {
            background: #6c757d;
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 20px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-left: 10px;
        }

        .reset-form-btn:hover {
            background: #5a6268;
            transform: scale(1.05);
        }

        .disclaimer {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            padding: 20px;
            margin-top: 30px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            border-left: 4px solid #17a2b8;
            font-size: 14px;
            color: #495057;
        }

        .disclaimer h6 {
            color: #17a2b8;
            margin-bottom: 10px;
            font-weight: 600;
        }

        @media (max-width: 768px) {
            .summary-grid {
                grid-template-columns: 1fr;
            }
            
            .performance-input-grid {
                grid-template-columns: 1fr 1fr;
            }
            
            h1 {
                font-size: 2rem;
            }
            
            .chart-container {
                padding: 15px;
            }
            
            .chart-container > div {
                height: 300px !important;
                max-height: 300px !important;
            }

            .search-tabs {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="main-container">
        <h1><i class="bi bi-graph-up"></i> Investment Performance Tool v2</h1>
        
        <!-- Search Section -->
        <div class="glass-card">
            <h4 class="mb-4"><i class="bi bi-search"></i> Search & Add Investments</h4>
            
            <!-- Search Tabs -->
            <div class="search-tabs">
                <button class="search-tab active" onclick="switchSearchTab('csv')">
                    <i class="bi bi-file-earmark-spreadsheet"></i> CSV Data
                </button>
                <button class="search-tab" onclick="switchSearchTab('morningstar')">
                    <i class="bi bi-globe"></i> Morningstar API
                </button>
                <button class="search-tab" onclick="switchSearchTab('manual')">
                    <i class="bi bi-plus-circle"></i> Manual Entry
                </button>
            </div>

            <!-- API Status -->
            <div id="apiStatus" class="api-status offline" style="display: none;">
                <i class="bi bi-exclamation-triangle"></i> Morningstar API is offline.
            </div>
            
            <!-- CSV Search Section -->
            <div id="csvSearch" class="search-section active">
                <div class="row">
                    <div class="col-md-5">
                        <div class="search-box">
                            <input type="text" id="nameSearch" placeholder="🔍 Search by investment name...">
                        </div>
                    </div>
                    <div class="col-md-5">
                        <div class="search-box">
                            <input type="text" id="apirSearch" placeholder="🔍 Search by APIR/ID code...">
                        </div>
                    </div>
                    <div class="col-md-2 d-flex align-items-center">
                        <button class="search-btn w-100" onclick="performCSVSearch()">
                            Search CSV
                        </button>
                    </div>
                </div>
            </div>

            <!-- Morningstar API Search Section -->
            <div id="morningstarSearch" class="search-section">
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i> <strong>Morningstar API:</strong> Search global investment data from Morningstar. Choose region and investment type for targeted results.
                </div>
                <div class="row">
                    <div class="col-md-3">
                        <div class="search-box">
                            <input type="text" id="morningstarName" placeholder="🔍 Search by name...">
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="search-box">
                            <input type="text" id="morningstarCode" placeholder="🔍 Search by code/ID...">
                        </div>
                    </div>
                    <div class="col-md-2">
                        <select id="morningstarRegion" class="form-control">
                            <option value="australia">Australia</option>
                            <option value="global">Global</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <select id="morningstarType" class="form-control">
                            <option value="combined">All Types</option>
                            <option value="funds">Funds Only</option>
                            <option value="stocks">Stocks Only</option>
                        </select>
                    </div>
                    <div class="col-md-2 d-flex align-items-center">
                        <button class="search-btn w-100" onclick="performMorningstarSearch()">
                            <i class="bi bi-search"></i> Search
                        </button>
                    </div>
                </div>
            </div>

            <!-- Manual Entry Section -->
            <div id="manualSearch" class="search-section">
                <form id="investmentForm">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="investmentName" class="form-label">Investment Name *</label>
                            <input type="text" class="form-control" id="investmentName" placeholder="Enter investment name..." required>
                        </div>
                        <div class="col-md-6">
                            <label for="apirCode" class="form-label">APIR Code</label>
                            <input type="text" class="form-control" id="apirCode" placeholder="Enter APIR code (optional)...">
                        </div>
                    </div>
                    
                    <div class="performance-input-grid">
                        <div class="performance-input-group">
                            <label for="threeMonths">3 Months (%)</label>
                            <input type="number" class="form-control" id="threeMonths" step="0.01" placeholder="0.00">
                        </div>
                        <div class="performance-input-group">
                            <label for="oneYear">1 Year (%)</label>
                            <input type="number" class="form-control" id="oneYear" step="0.01" placeholder="0.00">
                        </div>
                        <div class="performance-input-group">
                            <label for="threeYears">3 Years (%)</label>
                            <input type="number" class="form-control" id="threeYears" step="0.01" placeholder="0.00">
                        </div>
                        <div class="performance-input-group">
                            <label for="fiveYears">5 Years (%) *</label>
                            <input type="number" class="form-control" id="fiveYears" step="0.01" placeholder="0.00" required>
                        </div>
                        <div class="performance-input-group">
                            <label for="tenYears">10 Years (%)</label>
                            <input type="number" class="form-control" id="tenYears" step="0.01" placeholder="0.00">
                        </div>
                        <div class="performance-input-group">
                            <label for="tcr">TCR (%)</label>
                            <input type="number" class="form-control" id="tcr" step="0.01" placeholder="0.00">
                        </div>
                    </div>
                    
                    <div class="mt-4 text-center">
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-plus-circle"></i> Preview Investment
                        </button>
                        <button type="button" class="reset-form-btn" onclick="resetForm()">
                            <i class="bi bi-arrow-clockwise"></i> Reset
                        </button>
                    </div>
                </form>
                
                <!-- Investment Preview -->
                <div id="investmentPreview" style="display: none;">
                    <hr class="my-4">
                    <h5 class="mb-3">Investment Preview</h5>
                    <div class="investment-preview">
                        <div class="d-flex justify-content-between align-items-center flex-wrap">
                            <div>
                                <h6 class="mb-2" id="previewName">Investment Name</h6>
                                <small class="text-muted" id="previewDetails">APIR: N/A | TCR: N/A</small>
                                <div class="mt-2 d-flex flex-wrap" id="previewPerformance">
                                    <!-- Performance pills will be inserted here -->
                                </div>
                            </div>
                            <div class="mt-3">
                                <button class="btn-add-current" onclick="addToPortfolioFromManual('current')">
                                    <i class="bi bi-plus-circle"></i> Add to Current
                                </button>
                                <button class="btn-add-proposed" onclick="addToPortfolioFromManual('proposed')">
                                    <i class="bi bi-plus-circle"></i> Add to Proposed
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Search Results -->
            <div class="mt-4" id="searchResultsSection" style="display: none; max-width: 100%; overflow: hidden;">
                <h5 class="mb-3">Search Results</h5>
                <div id="searchResults" style="max-width: 100%; overflow-x: auto;"></div>
            </div>
        </div>

        <!-- Performance Summary -->
        <div class="summary-box" id="summarySection" style="display: none;">
            <h4><i class="bi bi-bar-chart-line"></i> Performance Summary</h4>
            <div class="summary-grid">
                <div class="summary-item">
                    <h5><i class="bi bi-folder2"></i> Current Portfolio</h5>
                    <div id="currentSummary">No investments selected</div>
                </div>
                <div class="summary-item">
                    <h5><i class="bi bi-folder2-open"></i> Proposed Portfolio</h5>
                    <div id="proposedSummary">No investments selected</div>
                </div>
            </div>
        </div>

        <!-- Portfolio Sections -->
        <div class="row">
            <!-- Current Portfolio -->
            <div class="col-lg-6 mb-4">
                <div class="portfolio-section portfolio-current">
                    <div class="portfolio-header">
                        <h4><i class="bi bi-briefcase"></i> Current Portfolio</h4>
                        <button class="btn-clear" onclick="clearPortfolio('current')">
                            <i class="bi bi-trash"></i> Clear
                        </button>
                    </div>
                    <div class="table-responsive">
                        <table class="portfolio-table">
                            <thead>
                                <tr>
                                    <th>Investment</th>
                                    <th>Code</th>
                                    <th>5 Years</th>
                                    <th>TCR</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody id="currentPortfolioBody">
                                <tr>
                                    <td colspan="5" class="empty-state">
                                        <i class="bi bi-inbox"></i>
                                        <div>No investments added</div>
                                    </td>
                                </tr>
                            </tbody>
                            <tfoot>
                                <tr style="background: #f8f9fa;">
                                    <td colspan="2"><strong>Average</strong></td>
                                    <td><strong id="currentAverage">-</strong></td>
                                    <td><strong id="currentTCRAverage">-</strong></td>
                                    <td></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Proposed Portfolio -->
            <div class="col-lg-6 mb-4">
                <div class="portfolio-section portfolio-proposed">
                    <div class="portfolio-header">
                        <h4><i class="bi bi-lightbulb"></i> Proposed Portfolio</h4>
                        <button class="btn-clear" onclick="clearPortfolio('proposed')">
                            <i class="bi bi-trash"></i> Clear
                        </button>
                    </div>
                    <div class="table-responsive">
                        <table class="portfolio-table">
                            <thead>
                                <tr>
                                    <th>Investment</th>
                                    <th>Code</th>
                                    <th>5 Years</th>
                                    <th>TCR</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody id="proposedPortfolioBody">
                                <tr>
                                    <td colspan="5" class="empty-state">
                                        <i class="bi bi-inbox"></i>
                                        <div>No investments added</div>
                                    </td>
                                </tr>
                            </tbody>
                            <tfoot>
                                <tr style="background: #f8f9fa;">
                                    <td colspan="2"><strong>Average</strong></td>
                                    <td><strong id="proposedAverage">-</strong></td>
                                    <td><strong id="proposedTCRAverage">-</strong></td>
                                    <td></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Comparison Chart -->
        <div class="chart-container" id="comparisonSection" style="display: none;">
            <h4 class="mb-4"><i class="bi bi-graph-up-arrow"></i> Performance Comparison</h4>
            <div style="position: relative; height: 400px; max-height: 400px; overflow: hidden;">
                <canvas id="comparisonChart"></canvas>
            </div>
        </div>

        <!-- Disclaimer -->
        <div class="disclaimer">
            <h6><i class="bi bi-info-circle"></i> Data Sources & Disclaimers</h6>
            <p class="mb-2">
                <strong>APL Data:</strong> Dated 05/05/2025 APL<br>
                <strong>Findex MDA Data:</strong> Dated 30/04/2025<br>
                <strong>Retail Fund Data:</strong> Dated 09/06/2025 Morningstar Research
            </p>
            <p class="mb-0">
                <small>
                    Performance data is historical and does not guarantee future results. Past performance is not indicative of future performance. 
                    All investment decisions should be made based on your individual circumstances and with professional financial advice.
                </small>
            </p>
        </div>

        <!-- Loading State -->
        <div class="loading" id="loadingState">
            <i class="bi bi-arrow-repeat"></i>
            <div>Loading investment data...</div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.0/papaparse.min.js"></script>
    
    <script>
        // Global variables
        let investmentsData = [];
        let currentPortfolio = [];
        let proposedPortfolio = [];
        let comparisonChart = null;
        let currentInvestment = null;
        
        // CHANGE THIS TO YOUR RENDER URL:
        const API_BASE_URL = 'https://investment-tool-9gxo.onrender.com/api';
        
        // Load data when page loads
        document.addEventListener('DOMContentLoaded', function() {
            loadCSVData();
            checkAPIStatus();
            
            // Form handling for manual entry
            document.getElementById('investmentForm').addEventListener('submit', function(e) {
                e.preventDefault();
                previewInvestment();
            });
        });

        // Check if Morningstar API is available
        async function checkAPIStatus() {
            try {
                const response = await fetch(`${API_BASE_URL}/health`);
                if (response.ok) {
                    document.getElementById('apiStatus').className = 'api-status online';
                    document.getElementById('apiStatus').innerHTML = '<i class="bi bi-check-circle"></i> Global Morningstar API is online!';
                    document.getElementById('apiStatus').style.display = 'block';
                }
            } catch (error) {
                document.getElementById('apiStatus').className = 'api-status offline';
                document.getElementById('apiStatus').innerHTML = '<i class="bi bi-exclamation-triangle"></i> Morningstar API is offline.';
                document.getElementById('apiStatus').style.display = 'block';
            }
        }

        // Switch between search tabs
        function switchSearchTab(tab) {
            // Update tab buttons
            document.querySelectorAll('.search-tab').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            // Update search sections
            document.querySelectorAll('.search-section').forEach(section => section.classList.remove('active'));
            
            if (tab === 'csv') {
                document.getElementById('csvSearch').classList.add('active');
            } else if (tab === 'morningstar') {
                document.getElementById('morningstarSearch').classList.add('active');
            } else if (tab === 'manual') {
                document.getElementById('manualSearch').classList.add('active');
            }
            
            // Clear previous results
            document.getElementById('searchResultsSection').style.display = 'none';
        }
        
        // Load CSV data
        function loadCSVData() {
            fetch('./2025(in).csv')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to load CSV file');
                    }
                    return response.text();
                })
                .then(data => {
                    parseCSV(data);
                    document.getElementById('loadingState').style.display = 'none';
                })
                .catch(error => {
                    console.error('Error loading CSV:', error);
                    document.getElementById('loadingState').innerHTML = `
                        <i class="bi bi-exclamation-circle text-danger"></i>
                        <div class="text-danger">Error loading investment data. Please ensure 2025(in).csv is in the same directory.</div>
                    `;
                });
        }
        
        // Parse CSV data
        function parseCSV(csvData) {
            Papa.parse(csvData, {
                header: true,
                skipEmptyLines: true,
                complete: function(results) {
                    // Check if the CSV has headers or if we need to assign them
                    if (results.data.length > 0) {
                        const firstRow = results.data[0];
                        const keys = Object.keys(firstRow);
                        
                        // If the first column doesn't look like "APIR CODE", assume no headers
                        if (!keys.includes('APIR CODE') && !keys.includes('INVESTMENT NAME')) {
                            // Parse without headers and assign them manually
                            Papa.parse(csvData, {
                                header: false,
                                skipEmptyLines: true,
                                complete: function(resultsNoHeader) {
                                    // Skip the first row if it contains headers
                                    const dataRows = resultsNoHeader.data;
                                    const startIndex = (dataRows[0] && dataRows[0][0] === 'APIR CODE') ? 1 : 0;
                                    
                                    const processedData = dataRows.slice(startIndex).map(row => ({
                                        'APIR CODE': row[0] || '',
                                        'INVESTMENT NAME': row[1] || '',
                                        '3 Months': row[2] || '',
                                        '1 Year': row[3] || '',
                                        '3 Years p.a': row[4] || '',
                                        '5 Years p.a': row[5] || '',
                                        '10 Years p.a': row[6] || '',
                                        'TCR': row[7] || ''
                                    }));
                                    
                                    processData(processedData);
                                }
                            });
                        } else {
                            processData(results.data);
                        }
                    }
                }
            });
        }
        
        // Process the data with correct column mappings
        function processData(data) {
            investmentsData = data.map(row => {
                // Parse performance values
                const parsePerformance = (value) => {
                    if (!value || value === '' || value === 'N/A') return null;
                    const parsed = parseFloat(value);
                    return isNaN(parsed) ? null : parsed;
                };
                
                return {
                    apir: row['APIR CODE'] || '',
                    name: row['INVESTMENT NAME'] || '',
                    threeMonths: parsePerformance(row['3 Months']),
                    oneYear: parsePerformance(row['1 Year']),
                    threeYears: parsePerformance(row['3 Years p.a']),
                    fiveYears: parsePerformance(row['5 Years p.a']),
                    tenYears: parsePerformance(row['10 Years p.a']),
                    tcr: parsePerformance(row['TCR']),
                    assetClass: 'Domestic Equity',
                    sector: '',
                    status: 'CSV Data',
                    country: 'Australia',
                    type: 'Fund'
                };
            }).filter(item => item.name && item.name.trim() !== '' && item.apir && item.apir.trim() !== '');
            
            console.log('Loaded', investmentsData.length, 'investments');
        }
        
        // Perform CSV search
        function performCSVSearch() {
            const nameQuery = document.getElementById('nameSearch').value.toLowerCase().trim();
            const apirQuery = document.getElementById('apirSearch').value.toLowerCase().trim();
            
            if (!nameQuery && !apirQuery) {
                alert('Please enter a search term');
                return;
            }
            
            let results = investmentsData.filter(item => {
                const nameMatch = nameQuery && item.name.toLowerCase().includes(nameQuery);
                const apirMatch = apirQuery && item.apir.toLowerCase().includes(apirQuery);
                return nameMatch || apirMatch;
            });
            
            displaySearchResults(results, 'CSV Data');
        }

        // Perform Morningstar search (merged Australian and Global)
        async function performMorningstarSearch() {
            const nameQuery = document.getElementById('morningstarName').value.trim();
            const codeQuery = document.getElementById('morningstarCode').value.trim();
            const region = document.getElementById('morningstarRegion').value;
            const searchType = document.getElementById('morningstarType').value;
            
            if (!nameQuery && !codeQuery) {
                alert('Please enter a search term (name or code)');
                return;
            }
            
            // Combine name and code queries
            const term = [nameQuery, codeQuery].filter(t => t).join(' ');
            
            // Show loading
            const resultsDiv = document.getElementById('searchResults');
            resultsDiv.innerHTML = '<div class="loading"><i class="bi bi-arrow-repeat"></i><div>Searching Morningstar...</div></div>';
            document.getElementById('searchResultsSection').style.display = 'block';

            try {
                let endpoint;
                let params = new URLSearchParams({
                    term: term,
                    pageSize: '30'
                });

                if (region === 'australia') {
                    // Use Australia-specific endpoint
                    endpoint = 'search/australia';
                    params.append('type', searchType);
                } else {
                    // Use global endpoint
                    if (searchType === 'combined') {
                        endpoint = 'search/combined';
                    } else if (searchType === 'funds') {
                        endpoint = 'search/funds';
                    } else {
                        endpoint = 'search/stocks';
                    }
                }

                const url = `${API_BASE_URL}/${endpoint}?${params}`;
                console.log('Fetching URL:', url);

                const response = await fetch(url);
                const data = await response.json();
                
                console.log('Morningstar search response:', data);
                
                if (data.success) {
                    const sourceLabel = region === 'australia' ? 'Morningstar Australia' : 'Morningstar Global';
                    displaySearchResults(data.results, sourceLabel);
                } else {
                    throw new Error(data.error || 'Search failed');
                }
                
            } catch (error) {
                console.error('Morningstar search error:', error);
                resultsDiv.innerHTML = `
                    <div class="alert alert-danger">
                        Error searching Morningstar: ${error.message}
                    </div>
                `;
            }
        }

        // Preview investment (for manual entry)
        function previewInvestment() {
            const name = document.getElementById('investmentName').value.trim();
            const apir = document.getElementById('apirCode').value.trim();
            const fiveYears = parseFloat(document.getElementById('fiveYears').value);
            
            if (!name) {
                alert('Please enter an investment name');
                return;
            }
            
            if (isNaN(fiveYears)) {
                alert('Please enter a value for 5 Years performance');
                return;
            }
            
            // Parse all performance values
            const parseValue = (id) => {
                const value = document.getElementById(id).value;
                return value === '' ? null : parseFloat(value);
            };
            
            currentInvestment = {
                name: name,
                apir: apir || 'N/A',
                threeMonths: parseValue('threeMonths'),
                oneYear: parseValue('oneYear'),
                threeYears: parseValue('threeYears'),
                fiveYears: fiveYears,
                tenYears: parseValue('tenYears'),
                tcr: parseValue('tcr'),
                assetClass: 'Manual Entry',
                sector: '',
                status: 'Manual',
                type: 'Manual Entry'
            };
            
            displayInvestmentPreview();
        }
        
        // Display investment preview
        function displayInvestmentPreview() {
            if (!currentInvestment) return;
            
            document.getElementById('previewName').textContent = currentInvestment.name;
            document.getElementById('previewDetails').textContent = 
                `APIR: ${currentInvestment.apir} ${currentInvestment.tcr !== null ? '| TCR: ' + currentInvestment.tcr.toFixed(2) + '%' : ''}`;
            
            // Generate performance pills
            const performanceDiv = document.getElementById('previewPerformance');
            performanceDiv.innerHTML = '';
            
            const periods = [
                { label: '3M', value: currentInvestment.threeMonths },
                { label: '1Y', value: currentInvestment.oneYear },
                { label: '3Y', value: currentInvestment.threeYears },
                { label: '5Y', value: currentInvestment.fiveYears, important: true },
                { label: '10Y', value: currentInvestment.tenYears }
            ];
            
            periods.forEach(period => {
                if (period.value !== null) {
                    const pill = document.createElement('span');
                    pill.className = `performance-pill ${period.value >= 0 ? 'performance-positive' : 'performance-negative'}`;
                    if (period.important) {
                        pill.innerHTML = `<strong>${period.label}: ${period.value.toFixed(2)}%</strong>`;
                    } else {
                        pill.textContent = `${period.label}: ${period.value.toFixed(2)}%`;
                    }
                    performanceDiv.appendChild(pill);
                }
            });
            
            document.getElementById('investmentPreview').style.display = 'block';
        }

        // Reset form (for manual entry)
        function resetForm() {
            document.getElementById('investmentForm').reset();
            document.getElementById('investmentPreview').style.display = 'none';
            currentInvestment = null;
        }

        // Add investment to portfolio from manual entry
        function addToPortfolioFromManual(portfolioType) {
            if (!currentInvestment) {
                alert('Please preview an investment first');
                return;
            }
            
            const portfolio = portfolioType === 'current' ? currentPortfolio : proposedPortfolio;
            
            // Check if already exists
            const exists = portfolio.some(item => 
                item.name.toLowerCase() === currentInvestment.name.toLowerCase() && 
                item.apir === currentInvestment.apir
            );
            if (exists) {
                alert('This investment is already in the ' + portfolioType + ' portfolio');
                return;
            }
            
            portfolio.push({...currentInvestment});
            updatePortfolioDisplay(portfolioType);
            updateSummary();
            
            // Reset form after adding
            resetForm();
            alert('Investment added to ' + portfolioType + ' portfolio successfully!');
        }
        
        // Display search results
        function displaySearchResults(results, source) {
            const resultsDiv = document.getElementById('searchResults');
            const resultsSection = document.getElementById('searchResultsSection');
            
            console.log('Displaying results:', results, 'Source:', source);
            
            if (results.length === 0) {
                resultsDiv.innerHTML = '<p class="text-muted text-center">No investments found</p>';
            } else {
                resultsDiv.innerHTML = results.map(item => {
                    const sourceClass = source.includes('Morningstar') ? 'morningstar' : '';
                    let badge;
                    
                    // Different badges for different sources
                    if (source === 'Morningstar Australia') {
                        badge = '<span class="badge bg-success ms-2">🇦🇺 AU</span>';
                    } else if (source === 'Morningstar Global') {
                        badge = '<span class="badge bg-danger ms-2">🌍 Global</span>';
                    } else {
                        badge = '<span class="badge bg-secondary ms-2">CSV</span>';
                    }
                    
                    // Add country badge for global results
                    if (item.country && source !== 'CSV Data') {
                        const countryCode = item.country.toLowerCase().substring(0, 2);
                        badge += `<span class="country-badge ${countryCode}">${item.country}</span>`;
                    }
                    
                    // Add type badge if available
                    if (item.type) {
                        badge += `<span class="badge bg-info ms-1">${item.type}</span>`;
                    }
                    
                    // Show more debugging info for APIR codes
                    const codeDisplay = item.apir || 'N/A';
                    let codeClass = '';
                    if (item.apir && item.apir.toUpperCase().includes('AU')) {
                        codeClass = 'text-success fw-bold';
                    }
                    
                    return `
                        <div class="investment-result ${sourceClass}">
                            <div class="d-flex justify-content-between align-items-center flex-wrap">
                                <div>
                                    <h6 class="mb-2">${item.name} ${badge}</h6>
                                    <small class="text-muted">
                                        Code: <span class="${codeClass}">${codeDisplay}</span>
                                        ${item.tcr !== null ? '| TCR: ' + item.tcr.toFixed(2) + '%' : ''}
                                        ${item.sector ? '| Sector: ' + item.sector : ''}
                                        ${item.exchange ? '| Exchange: ' + item.exchange : ''}
                                    </small>
                                    <div class="mt-2 d-flex flex-wrap">
                                        ${item.threeMonths !== null ? `<span class="performance-pill ${item.threeMonths >= 0 ? 'performance-positive' : 'performance-negative'}">3M: ${item.threeMonths.toFixed(2)}%</span>` : ''}
                                        ${item.oneYear !== null ? `<span class="performance-pill ${item.oneYear >= 0 ? 'performance-positive' : 'performance-negative'}">1Y: ${item.oneYear.toFixed(2)}%</span>` : ''}
                                        ${item.threeYears !== null ? `<span class="performance-pill ${item.threeYears >= 0 ? 'performance-positive' : 'performance-negative'}">3Y: ${item.threeYears.toFixed(2)}%</span>` : ''}
                                        ${item.fiveYears !== null ? `<span class="performance-pill ${item.fiveYears >= 0 ? 'performance-positive' : 'performance-negative'}"><strong>5Y: ${item.fiveYears.toFixed(2)}%</strong></span>` : ''}
                                        ${item.tenYears !== null ? `<span class="performance-pill ${item.tenYears >= 0 ? 'performance-positive' : 'performance-negative'}">10Y: ${item.tenYears.toFixed(2)}%</span>` : ''}
                                    </div>
                                </div>
                                <div>
                                    <button class="btn-add-current" onclick='addToPortfolio(${JSON.stringify(item).replace(/'/g, "&apos;")}, "current")'>
                                        <i class="bi bi-plus-circle"></i> Current
                                    </button>
                                    <button class="btn-add-proposed" onclick='addToPortfolio(${JSON.stringify(item).replace(/'/g, "&apos;")}, "proposed")'>
                                        <i class="bi bi-plus-circle"></i> Proposed
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            }
            
            resultsSection.style.display = 'block';
        }
        
        // Add investment to portfolio
        function addToPortfolio(investment, portfolioType) {
            const portfolio = portfolioType === 'current' ? currentPortfolio : proposedPortfolio;
            
            // Check if already exists
            const exists = portfolio.some(item => item.apir === investment.apir);
            if (exists) {
                alert('This investment is already in the ' + portfolioType + ' portfolio');
                return;
            }
            
            portfolio.push(investment);
            updatePortfolioDisplay(portfolioType);
            updateSummary();
        }
        
        // Update portfolio display
        function updatePortfolioDisplay(portfolioType) {
            const portfolio = portfolioType === 'current' ? currentPortfolio : proposedPortfolio;
            const tbody = document.getElementById(portfolioType + 'PortfolioBody');
            const averageEl = document.getElementById(portfolioType + 'Average');
            const tcrAverageEl = document.getElementById(portfolioType + 'TCRAverage');
            
            if (portfolio.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="empty-state">
                            <i class="bi bi-inbox"></i>
                            <div>No investments added</div>
                        </td>
                    </tr>
                `;
                averageEl.textContent = '-';
                tcrAverageEl.textContent = '-';
                return;
            }
            
            // Calculate averages
            const validInvestments = portfolio.filter(item => item.fiveYears !== null);
            const avgFiveYears = validInvestments.length > 0 
                ? validInvestments.reduce((sum, item) => sum + item.fiveYears, 0) / validInvestments.length 
                : null;
            
            const validTCRInvestments = portfolio.filter(item => item.tcr !== null);
            const avgTCR = validTCRInvestments.length > 0 
                ? validTCRInvestments.reduce((sum, item) => sum + item.tcr, 0) / validTCRInvestments.length 
                : null;
            
            // Update table
            tbody.innerHTML = portfolio.map((item, index) => {
                let sourceIcon;
                if (item.status === 'Morningstar Data' || item.source === 'Morningstar Australia') {
                    sourceIcon = '<i class="bi bi-flag text-success" title="Morningstar Australia"></i>';
                } else if (item.status === 'Morningstar Global' || item.source === 'Morningstar Global') {
                    sourceIcon = '<i class="bi bi-globe text-danger" title="Morningstar Global"></i>';
                } else if (item.status === 'Manual') {
                    sourceIcon = '<i class="bi bi-pencil text-primary" title="Manual Entry"></i>';
                } else {
                    sourceIcon = '<i class="bi bi-file-earmark-spreadsheet text-secondary" title="CSV Data"></i>';
                }
                
                const countryBadge = item.country ? `<small class="country-badge">${item.country}</small>` : '';
                
                return `
                    <tr>
                        <td>${sourceIcon} ${item.name} ${countryBadge}</td>
                        <td>${item.apir || 'N/A'}</td>
                        <td class="${item.fiveYears >= 0 ? 'text-success' : 'text-danger'}">
                            <strong>${item.fiveYears !== null ? item.fiveYears.toFixed(2) + '%' : 'N/A'}</strong>
                        </td>
                        <td>${item.tcr !== null ? item.tcr.toFixed(2) + '%' : 'N/A'}</td>
                        <td>
                            <button class="btn-remove" onclick="removeFromPortfolio(${index}, '${portfolioType}')">
                                <i class="bi bi-x"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
            
            // Update averages
            if (avgFiveYears !== null) {
                averageEl.textContent = avgFiveYears.toFixed(2) + '%';
                averageEl.className = avgFiveYears >= 0 ? 'text-success' : 'text-danger';
            } else {
                averageEl.textContent = 'N/A';
                averageEl.className = '';
            }
            
            if (avgTCR !== null) {
                tcrAverageEl.textContent = avgTCR.toFixed(2) + '%';
            } else {
                tcrAverageEl.textContent = 'N/A';
            }
        }
        
        // Remove investment from portfolio
        function removeFromPortfolio(index, portfolioType) {
            const portfolio = portfolioType === 'current' ? currentPortfolio : proposedPortfolio;
            portfolio.splice(index, 1);
            updatePortfolioDisplay(portfolioType);
            updateSummary();
        }
        
        // Clear portfolio
        function clearPortfolio(portfolioType) {
            if (confirm('Are you sure you want to clear the ' + portfolioType + ' portfolio?')) {
                if (portfolioType === 'current') {
                    currentPortfolio = [];
                } else {
                    proposedPortfolio = [];
                }
                updatePortfolioDisplay(portfolioType);
                updateSummary();
            }
        }
        
        // Update summary and comparison
        function updateSummary() {
            const summarySection = document.getElementById('summarySection');
            const comparisonSection = document.getElementById('comparisonSection');
            
            if (currentPortfolio.length === 0 && proposedPortfolio.length === 0) {
                summarySection.style.display = 'none';
                comparisonSection.style.display = 'none';
                return;
            }
            
            summarySection.style.display = 'block';
            
            // Update summary text
            const currentSummary = document.getElementById('currentSummary');
            const proposedSummary = document.getElementById('proposedSummary');
            
            if (currentPortfolio.length > 0) {
                const avgPerf = calculateAveragePerformance(currentPortfolio);
                const validTCR = currentPortfolio.filter(item => item.tcr !== null);
                const avgTCR = validTCR.length > 0 
                    ? validTCR.reduce((sum, item) => sum + item.tcr, 0) / validTCR.length 
                    : null;
                
                currentSummary.innerHTML = `
                    <div>3 Months: ${avgPerf.threeMonths !== null ? avgPerf.threeMonths.toFixed(2) + '%' : 'N/A'}</div>
                    <div>1 Year: ${avgPerf.oneYear !== null ? avgPerf.oneYear.toFixed(2) + '%' : 'N/A'}</div>
                    <div>3 Years: ${avgPerf.threeYears !== null ? avgPerf.threeYears.toFixed(2) + '%' : 'N/A'}</div>
                    <div><strong>5 Years: ${avgPerf.fiveYears !== null ? avgPerf.fiveYears.toFixed(2) + '%' : 'N/A'}</strong></div>
                    <div>10 Years: ${avgPerf.tenYears !== null ? avgPerf.tenYears.toFixed(2) + '%' : 'N/A'}</div>
                    <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid rgba(255,255,255,0.3);">
                        Average TCR: ${avgTCR !== null ? avgTCR.toFixed(2) + '%' : 'N/A'}
                    </div>
                `;
            } else {
                currentSummary.innerHTML = 'No investments selected';
            }
            
            if (proposedPortfolio.length > 0) {
                const avgPerf = calculateAveragePerformance(proposedPortfolio);
                const validTCR = proposedPortfolio.filter(item => item.tcr !== null);
                const avgTCR = validTCR.length > 0 
                    ? validTCR.reduce((sum, item) => sum + item.tcr, 0) / validTCR.length 
                    : null;
                
                proposedSummary.innerHTML = `
                    <div>3 Months: ${avgPerf.threeMonths !== null ? avgPerf.threeMonths.toFixed(2) + '%' : 'N/A'}</div>
                    <div>1 Year: ${avgPerf.oneYear !== null ? avgPerf.oneYear.toFixed(2) + '%' : 'N/A'}</div>
                    <div>3 Years: ${avgPerf.threeYears !== null ? avgPerf.threeYears.toFixed(2) + '%' : 'N/A'}</div>
                    <div><strong>5 Years: ${avgPerf.fiveYears !== null ? avgPerf.fiveYears.toFixed(2) + '%' : 'N/A'}</strong></div>
                    <div>10 Years: ${avgPerf.tenYears !== null ? avgPerf.tenYears.toFixed(2) + '%' : 'N/A'}</div>
                    <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid rgba(255,255,255,0.3);">
                        Average TCR: ${avgTCR !== null ? avgTCR.toFixed(2) + '%' : 'N/A'}
                    </div>
                `;
            } else {
                proposedSummary.innerHTML = 'No investments selected';
            }
            
            // Update comparison chart
            if (currentPortfolio.length > 0 || proposedPortfolio.length > 0) {
                comparisonSection.style.display = 'block';
                setTimeout(() => {
                    if (document.getElementById('comparisonSection').style.display !== 'none') {
                        updateComparisonChart();
                    }
                }, 100);
            } else {
                comparisonSection.style.display = 'none';
                if (comparisonChart) {
                    comparisonChart.destroy();
                    comparisonChart = null;
                }
            }
        }
        
        // Calculate average performance
        function calculateAveragePerformance(portfolio) {
            const calculateAvg = (field) => {
                const validItems = portfolio.filter(item => item[field] !== null);
                if (validItems.length === 0) return null;
                return validItems.reduce((sum, item) => sum + item[field], 0) / validItems.length;
            };
            
            return {
                threeMonths: calculateAvg('threeMonths'),
                oneYear: calculateAvg('oneYear'),
                threeYears: calculateAvg('threeYears'),
                fiveYears: calculateAvg('fiveYears'),
                tenYears: calculateAvg('tenYears')
            };
        }
        
        // Update comparison chart
        function updateComparisonChart() {
            const canvas = document.getElementById('comparisonChart');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            const currentAvg = calculateAveragePerformance(currentPortfolio);
            const proposedAvg = calculateAveragePerformance(proposedPortfolio);
            
            const data = {
                labels: ['3 Months', '1 Year', '3 Years', '5 Years', '10 Years'],
                datasets: []
            };
            
            if (currentPortfolio.length > 0) {
                data.datasets.push({
                    label: 'Current Portfolio',
                    data: [
                        currentAvg.threeMonths || 0,
                        currentAvg.oneYear || 0,
                        currentAvg.threeYears || 0,
                        currentAvg.fiveYears || 0,
                        currentAvg.tenYears || 0
                    ],
                    backgroundColor: 'rgba(52, 152, 219, 0.7)',
                    borderColor: 'rgba(52, 152, 219, 1)',
                    borderWidth: 2,
                    borderRadius: 10
                });
            }
            
            if (proposedPortfolio.length > 0) {
                data.datasets.push({
                    label: 'Proposed Portfolio',
                    data: [
                        proposedAvg.threeMonths || 0,
                        proposedAvg.oneYear || 0,
                        proposedAvg.threeYears || 0,
                        proposedAvg.fiveYears || 0,
                        proposedAvg.tenYears || 0
                    ],
                    backgroundColor: 'rgba(39, 174, 96, 0.7)',
                    borderColor: 'rgba(39, 174, 96, 1)',
                    borderWidth: 2,
                    borderRadius: 10
                });
            }
            
            if (comparisonChart) {
                comparisonChart.destroy();
                comparisonChart = null;
            }
            
            const container = canvas.parentElement;
            if (container.offsetWidth === 0 || container.offsetHeight === 0) {
                console.warn('Chart container has no dimensions, skipping chart creation');
                return;
            }
            
            comparisonChart = new Chart(ctx, {
                type: 'bar',
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    layout: {
                        padding: {
                            left: 10,
                            right: 10,
                            top: 10,
                            bottom: 10
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                },
                                stepSize: 5
                            },
                            grid: {
                                display: true,
                                drawBorder: false,
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                maxRotation: 0,
                                minRotation: 0
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            align: 'center',
                            labels: {
                                padding: 20,
                                usePointStyle: true,
                                font: {
                                    size: 14
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + context.parsed.y.toFixed(2) + '%';
                                }
                            },
                            backgroundColor: 'rgba(0,0,0,0.8)',
                            padding: 12,
                            cornerRadius: 8,
                            displayColors: true
                        }
                    },
                    animation: {
                        duration: 500
                    }
                }
            });
        }
        
        // Handle Enter key in search inputs
        document.getElementById('nameSearch').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') performCSVSearch();
        });
        
        document.getElementById('apirSearch').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') performCSVSearch();
        });

        document.getElementById('morningstarName').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') performMorningstarSearch();
        });

        document.getElementById('morningstarCode').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') performMorningstarSearch();
        });
        
        // Handle window resize for chart
        let resizeTimeout;
        window.addEventListener('resize', function() {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(function() {
                if (comparisonChart && document.getElementById('comparisonChart')) {
                    comparisonChart.resize();
                }
            }, 250);
        });
    </script>
</body>
</html>
